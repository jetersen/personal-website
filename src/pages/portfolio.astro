---
import Base from '../layouts/Base.astro';
import { SITE_NAME, GITHUB_USERNAME, INTERESTS } from '../consts';
import { fetchLangColors } from '../lib/langColors';

interface GitHubRepo {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  stargazers_count: number;
}

const exclude = ['.github', 'personal-website', 'jetersen', 'dotnet.restore.slow.github.action', 'dotnet-codespaces'];

let repos: GitHubRepo[] = [];
const token = import.meta.env.GITHUB_TOKEN;

try {
  const headers: Record<string, string> = {
    'Accept': 'application/vnd.github+json',
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const q = [
    `user:${GITHUB_USERNAME}`,
    'fork:false',
    'archived:false',
    'is:public',
    ...exclude.map((name) => `-repo:${GITHUB_USERNAME}/${name}`),
  ].join(' ');
  const res = await fetch(
    `https://api.github.com/search/repositories?q=${encodeURIComponent(q)}&sort=updated&per_page=10`,
    { headers },
  );

  if (res.ok) {
    const data: { items: GitHubRepo[] } = await res.json();
    repos = data.items;
  }
} catch {
  // Fall back to static link
}

let langColors: Record<string, string | null> = {};
try {
  langColors = await fetchLangColors();
} catch {
  // Colors are cosmetic, fine to skip
}

---

<>
<Base title={`Portfolio — ${SITE_NAME}`} description="Interests, projects, and open source work by Joseph Petersen.">
  <svg xmlns="http://www.w3.org/2000/svg" class="display-none">
    <defs>
      <symbol id="lang-dot" viewBox="0 0 16 16">
        <circle cx="8" cy="8" r="8" />
      </symbol>
      <symbol id="star-icon" viewBox="0 0 24 24">
        <path d="M12 .288l2.833 8.718h9.167l-7.417 5.389 2.833 8.718-7.416-5.388-7.417 5.388 2.833-8.718-7.416-5.389h9.167z"/>
      </symbol>
    </defs>
  </svg>
  <h1 class="page-title">Portfolio</h1>

    <section>
      <h2 class="section-header">Interests</h2>
      <div class="interests-links">
        {INTERESTS.map((interest, i) => (
          <>
            {i > 0 && <span class="dot" aria-hidden="true">·</span>}
            <a href={interest.href} target="_blank" rel="noopener noreferrer">{interest.label}</a>
          </>
        ))}
      </div>
    </section>

    <section>
      <h2 class="section-header">Projects</h2>
      {repos.length > 0 ? (
        <ul class="repo-list">
          {repos.map((repo) => (
            <li>
              <a href={repo.html_url} target="_blank" rel="noopener noreferrer">{repo.name}</a>
              {repo.description && <p class="repo-desc">{repo.description}</p>}
              <span class="repo-meta">
                {repo.language && (
                  <span class="repo-lang">
                    <svg class="lang-dot" width="12" height="12" aria-hidden="true">
                      <use href="#lang-dot" fill={langColors[repo.language] ?? 'currentColor'} />
                    </svg>
                    {repo.language}
                  </span>
                )}
                {repo.language && repo.stargazers_count > 0 && <span class="dot" aria-hidden="true">·</span>}
                {repo.stargazers_count > 0 && (
                  <span class="repo-lang">
                    <svg class="star" width="12" height="12" fill="currentColor" aria-hidden="true">
                      <use href="#star-icon" />
                    </svg>
                    {repo.stargazers_count}
                  </span>
                )}
              </span>
            </li>
          ))}
        </ul>
      ) : (
        <p>
          Check out my work on <a href={`https://github.com/${GITHUB_USERNAME}`} target="_blank" rel="noopener noreferrer">GitHub</a>.
        </p>
      )}
    </section>
</Base>
</>

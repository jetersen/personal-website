---
import Base from '../layouts/Base.astro';
import { SITE_NAME, GITHUB_USERNAME, INTERESTS } from '../consts';

interface GitHubRepo {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  stargazers_count: number;
}

const exclude = ['.github', 'personal-website', 'dotnet.restore.slow.github.action', 'dotnet-codespaces'];

let repos: GitHubRepo[] = [];
const token = import.meta.env.GITHUB_TOKEN;

try {
  const headers: Record<string, string> = {
    'Accept': 'application/vnd.github+json',
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const q = [
    `user:${GITHUB_USERNAME}`,
    'fork:false',
    'archived:false',
    'is:public',
    ...exclude.map((name) => `-repo:${GITHUB_USERNAME}/${name}`),
  ].join(' ');
  const res = await fetch(
    `https://api.github.com/search/repositories?q=${encodeURIComponent(q)}&sort=updated&per_page=10`,
    { headers },
  );

  if (res.ok) {
    const data: { items: GitHubRepo[] } = await res.json();
    repos = data.items;
  }
} catch {
  // Fall back to static link
}

let langColors: Record<string, string | null> = {};
try {
  const res = await fetch('https://raw.githubusercontent.com/ozh/github-colors/master/colors.json');
  if (res.ok) {
    const data: Record<string, { color: string | null }> = await res.json();
    for (const [lang, { color }] of Object.entries(data)) {
      langColors[lang] = color;
    }
  }
} catch {
  // Colors are cosmetic, fine to skip
}
---

<Base title={`Portfolio — ${SITE_NAME}`}>
  <div class="stagger">
    <h1 class="page-title">Portfolio</h1>

    <section>
      <h2 class="section-header">Interests</h2>
      <div class="interests-links">
        {INTERESTS.map((interest, i) => (
          <>
            {i > 0 && <span class="dot">·</span>}
            <a href={interest.href}>{interest.label}</a>
          </>
        ))}
      </div>
    </section>

    <section>
      <h2 class="section-header">Projects</h2>
      {repos.length > 0 ? (
        <ul class="repo-list">
          {repos.map((repo) => (
            <li>
              <a href={repo.html_url}>{repo.name}</a>
              {repo.description && <p class="repo-desc">{repo.description}</p>}
              <span class="repo-meta">
                {repo.language && (
                  <span class="repo-lang" {...(langColors[repo.language!] ? { style: `color: ${langColors[repo.language!]}` } : {})}>
                    <span class="lang-dot">●</span>
                    {repo.language}
                  </span>
                )}
                {repo.language && repo.stargazers_count > 0 && <span class="dot">·</span>}
                {repo.stargazers_count > 0 && <span><span class="star">★</span> {repo.stargazers_count}</span>}
              </span>
            </li>
          ))}
        </ul>
      ) : (
        <p>
          Check out my work on <a href={`https://github.com/${GITHUB_USERNAME}`}>GitHub</a>.
        </p>
      )}
    </section>
  </div>
</Base>
